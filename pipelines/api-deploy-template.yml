# Pipeline template for apig staging

parameters:
  apiProject: ''
  build_environment: ''
  target_environment: ''
  target_type: ''
  prep_condition: ''
  test_condition: ''

steps:
- bash: |
    if [ -z "$APIPROJECT" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"apiProject\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$BUILD_ENVIRONMENT" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"build_environment\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$TARGET_ENVIRONMENT" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"target_environment\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$TARGET_TYPE" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"target_type\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$PREP_CONDITION" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"prep_condition\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$TEST_CONDITION" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"test_condition\""
      echo "##vso[task.complete result=Failed;]"
    fi
  env:
    APIPROJECT: ${{parameters.apiProject}}
    BUILD_ENVIRONMENT: ${{parameters.build_environment}}
    TARGET_ENVIRONMENT: ${{parameters.target_environment}}
    TARGET_TYPE: ${{parameters.target_type}}
    PREP_CONDITION: ${{parameters.prep_condition}}
    TEST_CONDITION: ${{parameters.test_condition}}
  displayName: Check for required parameters

- bash: |
   echo "##vso[task.setvariable variable=build_environment_hostname]`jq -r '.values[] | select(.key == "hostname") | .value' environments/${{parameters.build_environment}}`"
   echo "##vso[task.setvariable variable=build_environment_ip]`jq -r '.values[] | select(.key == "ip") | .value' environments/${{parameters.build_environment}}`"
   echo "##vso[task.setvariable variable=build_environment_port]`jq -r '.values[] | select(.key == "port") | .value' environments/${{parameters.build_environment}}`"
   echo "##vso[task.setvariable variable=build_environment_insecureflag]`jq -r '.values[] | select(.key == "insecureflag") | .value' environments/${{parameters.build_environment}}`"
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: 'Read and parse API Gateway BUILD configuration, extract ip, hostname, port and insecureflag'

- bash: |
   echo "##vso[task.setvariable variable=target_environment_hostname]`jq -r '.values[] | select(.key == "hostname") | .value' environments/${{parameters.target_environment}}`"
   echo "##vso[task.setvariable variable=target_environment_ip]`jq -r '.values[] | select(.key == "ip") | .value' environments/${{parameters.target_environment}}`"
   echo "##vso[task.setvariable variable=target_environment_port]`jq -r '.values[] | select(.key == "port") | .value' environments/${{parameters.target_environment}}`"
   echo "##vso[task.setvariable variable=target_environment_insecureflag]`jq -r '.values[] | select(.key == "insecureflag") | .value' environments/${{parameters.target_environment}}`"
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: 'Read and parse API Gateway ${{parameters.target_type}} configuration, extract ip, hostname, port and insecureflag'

- task: JFrog.jfrog-artifactory-vsts-extension.artifactory-generic-download.ArtifactoryGenericDownload@3
  displayName: 'Artifactory Build Download'
  inputs:
    connection: '$(artifactoryService)'
    fileSpec: |
      {
          "files": [
              {
                  "pattern": "$(artifactoryFolder)/apigw-staging-test/$(Build.BuildId)_export.zip",
                  "target": "$(System.DefaultWorkingDirectory)/",
                  "flat": "true"
              }
          ]
      }

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(System.DefaultWorkingDirectory)/apigw-staging-test/$(Build.BuildId)_export.zip'
    artifactName: '${{parameters.target_type}}_import'

- script: |
    echo "##vso[task.setvariable variable=scopes]`jq -c '.' $(System.DefaultWorkingDirectory)/apis/${{parameters.apiProject}}/scopes.json`"
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: 'Prepare list of scopes to be imported'

- script: |
    newman run utilities/import/ImportAPI.json --reporters cli \
    --env-var importer_user=$(importer_user) \
    --env-var importer_password=$(importer_password) \
    --env-var initializer_user=$(initializer_user) \
    --env-var initializer_password=$(initializer_password) \
    --env-var scopes='$(scopes)' \
    --env-var file_Loc=$(System.DefaultWorkingDirectory)/$(Build.BuildId)_export.zip -e environments/${{parameters.target_environment}} \
    $(target_environment_insecureflag)
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: 'Import the Deployable To API Gateway ${{parameters.target_type}}'
  env:
    no_proxy: $(target_environment_ip)