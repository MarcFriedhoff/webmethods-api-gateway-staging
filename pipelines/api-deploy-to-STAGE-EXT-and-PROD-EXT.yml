# Pipeline for apig staging

trigger: none

# To do: Add apiProject as pipeline parameters (vs. pipeline variable)
# parameters:
# - name: apiProject
#   type: string
#   default: 'petstore'

variables:
- group: wm_test_apigw_staging_artifactory
- group: wm_test_apigw_staging_aliases

jobs:
- job: Build_and_deploy_to_STAGE_EXT
  variables:
  - group: wm_test_apigw_staging_common
  pool:
    name: '$(agent_pool)'
    vmImage: '$(agent_pool_vmImage)'
  steps:
  - checkout: self
    submodules: "true"
    persistCredentials: "true"
  - template: /pipelines/api-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      build_environment: $(environment_build)
      target_type: STAGE-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  - template: /pipelines/api-deploy-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_environment: $(environment_stage_ext)
      target_type: STAGE-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  condition: eq(variables['useArtifactory'], 'false')

- job: Build_and_deploy_to_PROD_EXT
  variables:
  - group: wm_test_apigw_staging_common
  pool:
    name: '$(agent_pool)'
    vmImage: '$(agent_pool_vmImage)'
  steps:
  - checkout: self
    submodules: "true"
    persistCredentials: "true"
  - template: /pipelines/api-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      build_environment: $(environment_build)
      target_type: PROD-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  - template: /pipelines/api-deploy-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_environment: $(environment_prod_ext)
      target_type: PROD-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  dependsOn: Build_and_deploy_to_STAGE_EXT
  condition: succeeded()

- job: Build_for_STAGE_EXT
  variables:
  - group: wm_test_apigw_staging_build
  pool:
    name: '$(agent_pool)'
    vmImage: '$(agent_pool_vmImage)'
  steps:
  - checkout: self
    submodules: "true"
    persistCredentials: "true"
  - template: /pipelines/api-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      build_environment: $(environment)
      target_type: STAGE-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  - template: /pipelines/store-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_type: STAGE-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  condition: eq(variables['useArtifactory'], 'true')

- job: Deploy_to_STAGE_EXT
  variables:
  - group: wm_test_apigw_staging_stage_ext
  pool:
    name: '$(agent_pool)'
    vmImage: '$(agent_pool_vmImage)'
  steps:
  - template: /pipelines/retrieve-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_type: STAGE-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  - template: /pipelines/api-deploy-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_environment: $(environment)
      target_type: STAGE-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  dependsOn: Build_for_STAGE_EXT
  condition: succeeded()

- job: Build_for_PROD_EXT
  variables:
  - group: wm_test_apigw_staging_build
  pool:
    name: '$(agent_pool)'
    vmImage: '$(agent_pool_vmImage)'
  steps:
  - checkout: self
    submodules: "true"
    persistCredentials: "true"
  - template: /pipelines/api-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      build_environment: $(environment)
      target_type: PROD-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  - template: /pipelines/store-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_type: PROD-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  dependsOn: Deploy_to_STAGE_EXT
  condition: succeeded()

- job: Deploy_to_PROD_EXT
  variables:
  - group: wm_test_apigw_staging_prod_ext
  pool:
    name: '$(agent_pool)'
    vmImage: '$(agent_pool_vmImage)'
  steps:
  - template: /pipelines/retrieve-build-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_type: PROD-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  - template: /pipelines/api-deploy-template.yml  # Template reference
    parameters:
      apiProject: $(apiProject)
      target_environment: $(environment)
      target_type: PROD-EXT
      prep_condition: ${{true}}
      test_condition: ${{true}}
  dependsOn: Build_for_PROD_EXT
  condition: succeeded()